version: '3.1'

networks:
  hono-net:
    driver: overlay

secrets:
  permissions.json:
    file: sandbox-permissions.json
  qdrouterd.json:
    file: sandbox-qdrouterd.json

services:

  qdrouter:
    image: ${sandbox.repo}/dispatch-router:${sandbox.version}
    networks:
      - hono-net
    ports:
      - "15671:5671"
      - "15672:5672"
    secrets:
      - source: qdrouterd.json
    command: /usr/sbin/qdrouterd -c /run/secrets/qdrouterd.json

  hono:
    image: ${sandbox.repo}/hono-server:${sandbox.version}
    networks:
      - hono-net
    ports:
      - "5671:5671"
      - "5672:5672"
    secrets:
      - source: permissions.json
        mode: 0644
    environment:
      - HONO_AUTHORIZATION_PERMISSIONS_PATH=file:/run/secrets/permissions.json
      - HONO_DOWNSTREAM_HOST=qdrouter
      - HONO_DOWNSTREAM_PORT=5673
      - HONO_DOWNSTREAM_KEY_PATH=/etc/hono/certs/hono-key.pem
      - HONO_DOWNSTREAM_CERT_PATH=/etc/hono/certs/hono-cert.pem
      - HONO_DOWNSTREAM_TRUST_STORE_PATH=/etc/hono/certs/trusted-certs.pem
      - HONO_REGISTRATION_MODIFICATION_ENABLED=false
      - HONO_REGISTRATION_SAFE_TO_FILE=false
      - HONO_SERVER_BIND_ADDRESS=0.0.0.0
      - HONO_SERVER_KEY_PATH=/etc/hono/certs/hono-key.pem
      - HONO_SERVER_CERT_PATH=/etc/hono/certs/hono-cert.pem
      - HONO_SERVER_INSECURE_PORT_ENABLED=true
      - HONO_SERVER_MAX_INSTANCES=1
      - LOGGING_CONFIG=classpath:logback-spring.xml
      - SPRING_PROFILES_ACTIVE=default,prod
    volumes:
      - /home/hono/registration

  rest-adapter:
    image: ${sandbox.repo}/hono-adapter-rest-vertx:${sandbox.version}
    networks:
      - hono-net
    ports:
      - "8080:8080"
    environment:
      - HONO_CLIENT_NAME=Hono REST Adapter
      - HONO_CLIENT_HOST=hono
      - HONO_CLIENT_PORT=5671
      - HONO_CLIENT_USERNAME=rest-adapter
      - HONO_CLIENT_PASSWORD=secret
      - HONO_CLIENT_TRUST_STORE_PATH=/etc/hono/certs/trusted-certs.pem
      - HONO_HTTP_BIND_ADDRESS=0.0.0.0
      - HONO_HTTP_MAX_INSTANCES=1
      - SPRING_PROFILES_ACTIVE=prod

  mqtt-adapter:
    image: ${sandbox.repo}/hono-adapter-mqtt-vertx:${sandbox.version}
    networks:
      - hono-net
    ports:
      - "1883:1883"
    environment:
      - HONO_CLIENT_NAME=Hono MQTT Adapter
      - HONO_CLIENT_HOST=hono
      - HONO_CLIENT_PORT=5671
      - HONO_CLIENT_USERNAME=mqtt-adapter
      - HONO_CLIENT_PASSWORD=secret
      - HONO_CLIENT_TRUST_STORE_PATH=/etc/hono/certs/trusted-certs.pem
      - HONO_MQTT_BIND_ADDRESS=0.0.0.0
      - HONO_MQTT_MAX_INSTANCES=1
      - SPRING_PROFILES_ACTIVE=prod
