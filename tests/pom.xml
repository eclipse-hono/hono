<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (c) 2016, 2020 Contributors to the Eclipse Foundation
   
    See the NOTICE file(s) distributed with this work for additional
    information regarding copyright ownership.
   
    This program and the accompanying materials are made available under the
    terms of the Eclipse Public License 2.0 which is available at
    http://www.eclipse.org/legal/epl-2.0
   
    SPDX-License-Identifier: EPL-2.0
 -->
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <parent>
    <groupId>org.eclipse.hono</groupId>
    <artifactId>hono-bom</artifactId>
    <version>1.5.0-SNAPSHOT</version>
    <relativePath>../bom</relativePath>
  </parent>
  <modelVersion>4.0.0</modelVersion>

  <artifactId>hono-tests</artifactId>

  <name>Hono Integration Tests</name>
  <description>Integration tests verifying Hono's APIs.
Test cases are run against Docker images of Hono server + (Apache Qpid Dispatch Router and ActiveMQ Artemis broker).</description>
  <url>https://www.eclipse.org/hono</url>

  <properties>
    <maven.javadoc.skip>true</maven.javadoc.skip>
    <maven.source.skip>true</maven.source.skip>
    <maven.install.skip>true</maven.install.skip>
    <gpg.skip>true</gpg.skip>
    <service.startup.timeout>120000</service.startup.timeout>
    <link.establishment.timeout>5000</link.establishment.timeout>
    <flow.latency>1000</flow.latency>
    <request.timeout>500</request.timeout>
    <adapter.sendMessageToDeviceTimeout>1000</adapter.sendMessageToDeviceTimeout>
    <!-- use minimum cost factor in order to speed up test execution -->
    <max.bcrypt.costFactor>4</max.bcrypt.costFactor>
    <max.event-loop.execute-time>5000</max.event-loop.execute-time>
    <!-- should be set to false if testing against a registry that doesn't support GW mode -->
    <deviceregistry.supportsGatewayMode>true</deviceregistry.supportsGatewayMode>
    <deviceregistry.credentials.supportsClientContext>true</deviceregistry.credentials.supportsClientContext>
    <!-- should be set to true if testing against a registry that supports search devices operation -->
    <deviceregistry.supportsSearchDevices>true</deviceregistry.supportsSearchDevices>
    <hono.amqp-network.host>hono-dispatch-router.hono</hono.amqp-network.host>
    <hono.device-connection.host>hono-service-device-connection.hono</hono.device-connection.host>
    <hono.registration.host>hono-service-device-registry.hono</hono.registration.host>
    <hono.auth.host>hono-service-auth.hono</hono.auth.host>
    <default.java.options>
      -XX:MinRAMPercentage=80
      -XX:MaxRAMPercentage=90
      -DenableForcedCommandRerouting=true
    </default.java.options>
    <amqp.java.options></amqp.java.options>
    <coap.java.options></coap.java.options>
    <http.java.options></http.java.options>
    <mqtt.java.options></mqtt.java.options>
    <deviceregistry.image>hono-service-device-registry-file</deviceregistry.image>
    <hono.deviceregistry.resources.folder>deviceregistry</hono.deviceregistry.resources.folder>
    <hono.mongodb.image.repository>mongo</hono.mongodb.image.repository>
    <hono.mongodb.disabled>true</hono.mongodb.disabled>
    <!-- logging profile: either prod, dev or trace -->
    <logging.profile>prod</logging.profile>
    <trace.frames>0</trace.frames>
    <jaeger.disabled>true</jaeger.disabled>
    <jaeger.host>hono-jaeger.hono</jaeger.host>
    <jaeger.query.port>18080</jaeger.query.port>
    <log.color.amqp-network>magenta</log.color.amqp-network>
    <log.color.hono-device-registry>green</log.color.hono-device-registry>
    <log.color.hono-protocol-adapters>red</log.color.hono-protocol-adapters>
    <log.color.hono-services>yellow</log.color.hono-services>
    <log.color.extra-services>cyan</log.color.extra-services>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.junit.jupiter</groupId>
      <artifactId>junit-jupiter-engine</artifactId>
    </dependency>
    <dependency>
      <groupId>org.junit.jupiter</groupId>
      <artifactId>junit-jupiter-params</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.vertx</groupId>
      <artifactId>vertx-junit5</artifactId>
    </dependency>
    <dependency>
      <groupId>org.eclipse.hono</groupId>
      <artifactId>hono-client</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.eclipse.hono</groupId>
      <artifactId>hono-core</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.eclipse.hono</groupId>
      <artifactId>hono-service-device-registry-base</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.eclipse.hono</groupId>
      <artifactId>hono-service-device-registry-base</artifactId>
      <version>${project.version}</version>
      <classifier>tests</classifier>
      <type>test-jar</type>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.vertx</groupId>
      <artifactId>vertx-core</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.vertx</groupId>
      <artifactId>vertx-proton</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>ch.qos.logback</groupId>
      <artifactId>logback-classic</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.apache.qpid</groupId>
      <artifactId>qpid-jms-client</artifactId>
    </dependency>
    <dependency>
      <groupId>org.eclipse.hono</groupId>
      <artifactId>hono-demo-certs</artifactId>
    </dependency>
    <dependency>
      <groupId>io.vertx</groupId>
      <artifactId>vertx-mqtt</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.netty</groupId>
      <artifactId>netty-tcnative-boringssl-static</artifactId>
      <version>${netty.tcnative.version}</version>
    </dependency>

    <dependency>
      <groupId>org.eclipse.californium</groupId>
      <artifactId>californium-core</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.eclipse.californium</groupId>
      <artifactId>scandium</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.assertj</groupId>
      <artifactId>assertj-core</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.netty</groupId>
      <artifactId>netty-transport-native-epoll</artifactId>
      <classifier>linux-x86_64</classifier>
      <scope>runtime</scope>
    </dependency>
    <dependency>
      <groupId>io.netty</groupId>
      <artifactId>netty-transport-native-kqueue</artifactId>
      <classifier>osx-x86_64</classifier>
      <scope>runtime</scope>
    </dependency>
  </dependencies>

  <build>
    <resources>
      <resource>
        <directory>${project.basedir}/src/test/resources</directory>
        <filtering>true</filtering>
        <targetPath>${project.build.directory}/resources</targetPath>
      </resource>
    </resources>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-checkstyle-plugin</artifactId>
      </plugin>
    </plugins>
  </build>

  <profiles>
    <profile>
      <id>ci_environment</id>
      <activation>
        <property>
          <name>CI</name>
        </property>
      </activation>
      <!-- 
        relax timeouts when running on CI environment in order to account for (very) limited
        CPU resources.
       -->
      <properties>
        <adapter.sendMessageToDeviceTimeout>3000</adapter.sendMessageToDeviceTimeout>
        <max.event-loop.execute-time>20000</max.event-loop.execute-time>
        <request.timeout>3000</request.timeout>
        <service.startup.timeout>240000</service.startup.timeout>
      </properties>
    </profile>
    <profile>
      <id>device-registry-mongodb</id>
      <activation>
        <property>
          <name>hono.deviceregistry.type</name>
          <value>mongodb</value>
        </property>
      </activation>
      <properties>
        <deviceregistry.image>hono-service-device-registry-mongodb</deviceregistry.image>
        <hono.mongodb.disabled>false</hono.mongodb.disabled>
        <hono.mongodb.host>hono-mongodb.hono</hono.mongodb.host>
        <hono.mongodb.port>27017</hono.mongodb.port>
        <hono.mongodb.username>device-registry@HONO</hono.mongodb.username>
        <hono.mongodb.password>device-registry-secret</hono.mongodb.password>
        <hono.mongodb.database.name>hono-it-tests</hono.mongodb.database.name>
        <hono.deviceregistry.resources.folder>deviceregistry-mongodb</hono.deviceregistry.resources.folder>
        <deviceregistry.supportsSearchDevices>true</deviceregistry.supportsSearchDevices>
      </properties>
    </profile>
    <profile>
      <id>run-tests</id>
      <build>
        <plugins>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-dependency-plugin</artifactId>
            <executions>
              <execution>
                <!--
                  Execution and configuration for copying certificates and config files
                  from related modules "target/config" folder so that we can include them in the image.
                 -->
                <id>copy_demo_certs</id>
                <phase>generate-resources</phase>
                <goals>
                  <goal>unpack-dependencies</goal>
                </goals>
                <configuration>
                  <includeArtifactIds>hono-demo-certs</includeArtifactIds>
                  <outputDirectory>${project.build.directory}/certs</outputDirectory>
                  <includes>
                    *.pem,
                    *.p12,
                    *.jks
                  </includes>
                  <useSubDirectoryPerArtifact>false</useSubDirectoryPerArtifact>
                  <stripClassifier>true</stripClassifier>
                  <stripVersion>true</stripVersion>
                  <excludeTransitive>true</excludeTransitive>
                </configuration>
              </execution>
            </executions>
          </plugin>
          <plugin>
            <groupId>io.fabric8</groupId>
            <artifactId>docker-maven-plugin</artifactId>
            <configuration>
              <verbose>true</verbose>
              <autoCreateCustomNetworks>true</autoCreateCustomNetworks>
              <startParallel>false</startParallel>
              <images>
                <!-- ##### Mongo DB instance for the device registry ##### -->
                <image>
                  <name>${docker.repository}/hono-mongodb-test</name>
                  <alias>mongo</alias>
                  <build>
                    <skip>${hono.mongodb.disabled}</skip>
                    <imagePullPolicy>IfNotPresent</imagePullPolicy>
                    <from>${hono.mongodb.image.repository}:${mongodb.version}</from>
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/</basedir>
                      <inline>
                        <id>config</id>
                        <fileSet>
                          <directory>${project.build.directory}/resources/mongodb/init_db</directory>
                          <outputDirectory>docker-entrypoint-initdb.d/</outputDirectory>
                          <includes>
                            <include>*</include>
                          </includes>
                        </fileSet>
                        <file>
                          <source>${project.build.directory}/resources/mongodb/mongod.conf</source>
                          <outputDirectory>etc/mongo/</outputDirectory>
                        </file>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <skip>${hono.mongodb.disabled}</skip>
                    <cmd>
                      <arg>--config</arg>
                      <arg>/etc/mongo/mongod.conf</arg>
                    </cmd>
                    <ports>
                      <port>+mongodb.ip:mongodb.port:${hono.mongodb.port}</port>
                    </ports>
                    <portPropertyFile>${project.build.directory}/docker/mongodb.port.properties</portPropertyFile>
                    <env>
                      <MONGO_INITDB_DATABASE>${hono.mongodb.database.name}</MONGO_INITDB_DATABASE>
                    </env>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                      <alias>${hono.mongodb.host}</alias>
                    </network>
                    <memorySwap>524288000</memorySwap>
                    <memory>524288000</memory>
                    <log>
                      <prefix>MONGODB</prefix>
                      <color>${log.color.hono-device-registry}</color>
                    </log>
                    <wait>
                      <time>${service.startup.timeout}</time>
                      <log>.*(waiting for connections on port).*</log>
                    </wait>
                  </run>
                </image>
                <!-- ##### Jaeger tracing component ##### -->
                <image>
                  <name>${docker.repository}/hono-jaeger-all-in-one-test</name>
                  <alias>jaeger</alias>
                  <build>
                    <imagePullPolicy>IfNotPresent</imagePullPolicy>
                    <from>${jaeger.image.name}</from>
                  </build>
                  <run>
                    <skip>${jaeger.disabled}</skip>
                    <ports>
                      <port>+jaeger.ip:jaeger.health.port:8088</port><!-- admin-http -->
                      <port>+jaeger.ip:jaeger.query.port:16686</port><!-- query-http -->
                      <port>+jaeger.ip:jaeger.agent.port:6831/udp</port><!-- agent (compact thrift protocol) -->
                    </ports>
                    <portPropertyFile>${project.build.directory}/docker/jaeger.port.properties</portPropertyFile>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                      <alias>hono-jaeger.hono</alias>
                    </network>
                    <!--
                      Setting the swap property to the same value as the memory property effectively
                      prevents the container from swapping at all.
                      This way we can force the same behavior for running the integration
                      tests on both a local machine (which usually has swap space available) as
                      well as on Travis where there is no swap space available on the build job VMs.
                      We can thus detect OOM problems when running locally as opposed to only
                      later on Travis.
                     -->
                    <memorySwap>205520896</memorySwap>
                    <memory>205520896</memory>
                    <env>
                      <ADMIN_HTTP_PORT>8088</ADMIN_HTTP_PORT>
                      <MEMORY_MAX_TRACES>100000</MEMORY_MAX_TRACES>
                    </env>
                    <log>
                      <prefix>JAEGER</prefix>
                      <color>${log.color.extra-services}</color>
                    </log>
                    <wait>
                      <time>${service.startup.timeout}</time>
                      <http>
                        <method>GET</method>
                        <url>http://${jaeger.ip}:${jaeger.health.port}/health</url>
                        <status>200..299</status>
                      </http>
                    </wait>
                  </run>
                </image>
                <!-- ##### Authentication service ##### -->
                <image>
                  <name>${docker.repository}/hono-service-auth-test</name>
                  <alias>auth</alias>
                  <build>
                    <imagePullPolicy>IfNotPresent</imagePullPolicy>
                    <from>${docker.repository}/hono-service-auth:${project.version}</from>
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/</basedir>
                      <inline>
                        <id>config</id>
                        <fileSets>
                          <fileSet>
                            <directory>${project.build.directory}/resources/auth</directory>
                            <outputDirectory>etc/hono</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                          <fileSet>
                            <directory>${project.build.directory}/certs</directory>
                            <outputDirectory>etc/hono/certs</outputDirectory>
                            <includes>
                              <include>auth-server-*.pem</include>
                            </includes>
                          </fileSet>
                        </fileSets>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <ports>
                      <port>+auth.ip:auth.amqp.port:5672</port>
                      <port>+auth.ip:auth.health.port:${vertx.health.port}</port>
                    </ports>
                    <portPropertyFile>${project.build.directory}/docker/auth.port.properties</portPropertyFile>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                      <alias>hono-service-auth.hono</alias>
                    </network>
                    <!-- 
                      Setting the swap property to the same value as the memory property effectively
                      prevents the container from swapping at all.
                      This way we can force the same behavior for running the integration
                      tests on both a local machine (which usually has swap space available) as
                      well as on Travis where there is no swap space available on the build job VMs.
                      We can thus detect OOM problems when running locally as opposed to only
                      later on Travis.
                     -->
                    <memorySwap>205520896</memorySwap>
                    <memory>205520896</memory>
                    <env>
                      <LOGGING_CONFIG>file:///etc/hono/logback-spring.xml</LOGGING_CONFIG>
                      <SPRING_CONFIG_LOCATION>file:///etc/hono/</SPRING_CONFIG_LOCATION>
                      <SPRING_PROFILES_ACTIVE>authentication-impl,${logging.profile}</SPRING_PROFILES_ACTIVE>
                      <JDK_JAVA_OPTIONS>${default.java.options}</JDK_JAVA_OPTIONS>
                      <PN_TRACE_FRM>0</PN_TRACE_FRM>
                    </env>
                    <log>
                      <prefix>AUTH</prefix>
                      <color>${log.color.hono-services}</color>
                    </log>
                    <wait>
                      <time>${service.startup.timeout}</time>
                      <http>
                        <method>GET</method>
                        <url>http://${auth.ip}:${auth.health.port}/readiness</url>
                        <status>200..299</status>
                      </http>
                    </wait>
                  </run>
                </image>
                <!-- ##### Device Registration service ##### -->
                <image>
                  <name>${docker.repository}/hono-service-device-registry-test</name>
                  <alias>device-registry</alias>
                  <build>
                    <imagePullPolicy>IfNotPresent</imagePullPolicy>
                    <from>${docker.repository}/${deviceregistry.image}:${project.version}</from>
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/</basedir>
                      <inline>
                        <id>config</id>
                        <fileSets>
                          <fileSet>
                            <directory>${project.build.directory}/resources/${hono.deviceregistry.resources.folder}</directory>
                            <outputDirectory>etc/hono</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                          <fileSet>
                            <directory>${project.build.directory}/certs</directory>
                            <outputDirectory>etc/hono/certs</outputDirectory>
                            <includes>
                              <include>device-registry-*.pem</include>
                              <include>auth-server-cert.pem</include>
                              <include>trusted-certs.pem</include>
                            </includes>
                          </fileSet>
                        </fileSets>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <ports>
                      <port>+deviceregistry.ip:deviceregistry.amqp.port:5672</port>
                      <port>+deviceregistry.ip:deviceregistry.http.port:8080</port>
                      <port>+deviceregistry.ip:deviceregistry.health.port:${vertx.health.port}</port>
                    </ports>
                    <portPropertyFile>${project.build.directory}/docker/deviceregistry.port.properties</portPropertyFile>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                      <alias>hono-service-device-registry.hono</alias>
                    </network>
                    <memorySwap>314572800</memorySwap>
                    <memory>314572800</memory>
                    <env>
                      <LOGGING_CONFIG>file:///etc/hono/logback-spring.xml</LOGGING_CONFIG>
                      <SPRING_CONFIG_LOCATION>file:///etc/hono/</SPRING_CONFIG_LOCATION>
                      <SPRING_PROFILES_ACTIVE>${logging.profile}</SPRING_PROFILES_ACTIVE>
                      <JDK_JAVA_OPTIONS>${default.java.options}</JDK_JAVA_OPTIONS>
                      <PN_TRACE_FRM>0</PN_TRACE_FRM>
                      <JAEGER_SERVICE_NAME>device-registry</JAEGER_SERVICE_NAME>
                      <JAEGER_AGENT_HOST>${jaeger.host}</JAEGER_AGENT_HOST>
                      <JAEGER_AGENT_PORT>6831</JAEGER_AGENT_PORT>
                      <JAEGER_SAMPLER_TYPE>const</JAEGER_SAMPLER_TYPE>
                      <JAEGER_SAMPLER_PARAM>1</JAEGER_SAMPLER_PARAM>
                    </env>
                    <log>
                      <prefix>REGISTRY</prefix>
                      <color>${log.color.hono-device-registry}</color>
                    </log>
                    <wait>
                      <time>${service.startup.timeout}</time>
                      <http>
                        <method>GET</method>
                        <url>http://${deviceregistry.ip}:${deviceregistry.health.port}/readiness</url>
                        <status>200..299</status>
                      </http>
                    </wait>
                  </run>
                </image>
                <!-- ##### ActiveMQ Artemis message broker ##### -->
                <image>
                  <name>${docker.repository}/hono-artemis-test:${project.version}</name>
                  <alias>artemis</alias>
                  <build>
                    <imagePullPolicy>IfNotPresent</imagePullPolicy>
                    <from>${artemis.image.name}</from>
                    <ports>
                      <port>5671</port>
                    </ports>
                    <entryPoint>
                      <shell>/opt/apache-artemis/bin/launch.sh start</shell>
                    </entryPoint>
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/opt/apache-artemis/conf</basedir>
                      <inline>
                        <id>config</id>
                        <fileSets>
                          <fileSet>
                            <directory>${project.build.directory}/resources/artemis</directory>
                            <outputDirectory>.</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                          <fileSet>
                            <directory>${project.build.directory}/certs</directory>
                            <outputDirectory>.</outputDirectory>
                            <includes>
                              <include>artemisKeyStore.p12</include>
                              <include>trustStore.jks</include>
                            </includes>
                          </fileSet>
                        </fileSets>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <ports>
                      <port>+broker.ip:broker.amqp.port:5671</port>
                    </ports>
                    <portPropertyFile>${project.build.directory}/docker/broker.port.properties</portPropertyFile>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                      <alias>hono-artemis.hono</alias>
                    </network>
                    <memorySwap>419430400</memorySwap>
                    <memory>419430400</memory>
                    <env>
                      <AMQ_NAME>custom</AMQ_NAME>
                      <HOME>/var/run/artemis/</HOME>
                      <PN_TRACE_FRM>0</PN_TRACE_FRM>
                    </env>
                    <log>
                      <prefix>ARTEMIS</prefix>
                      <color>${log.color.amqp-network}</color>
                    </log>
                    <wait>
                      <time>${service.startup.timeout}</time>
                      <log>.*(Server is now live)$</log>
                    </wait>
                  </run>
                </image>
                <!-- ##### Qpid Dispatch Router ##### -->
                <image>
                  <name>${docker.repository}/hono-dispatch-router-test:${project.version}</name>
                  <alias>qdrouter</alias>
                  <build>
                    <imagePullPolicy>IfNotPresent</imagePullPolicy>
                    <from>${dispatch-router.image.name}</from>
                    <ports>
                      <port>5671</port>
                      <port>5672</port>
                      <port>5673</port>
                    </ports>
                    <cmd>
                      <exec>
                        <arg>/sbin/qdrouterd</arg>
                        <arg>-c</arg>
                        <arg>/etc/hono/qdrouterd-with-broker.json</arg>
                      </exec>
                    </cmd>
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/etc/hono</basedir>
                      <inline>
                        <id>config</id>
                        <fileSets>
                          <fileSet>
                            <directory>${project.build.directory}/resources/qpid</directory>
                            <outputDirectory>.</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                          <fileSet>
                            <directory>${project.build.directory}/certs</directory>
                            <outputDirectory>.</outputDirectory>
                            <includes>
                              <include>qdrouter-*.pem</include>
                              <include>trusted-certs.pem</include>
                            </includes>
                          </fileSet>
                        </fileSets>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <ports>
                      <port>+qpid.ip:qpid.amqp.port:5672</port>
                    </ports>
                    <portPropertyFile>${project.build.directory}/docker/qpid.port.properties</portPropertyFile>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                      <alias>hono-dispatch-router.hono</alias>
                    </network>
                    <memorySwap>268435456</memorySwap>
                    <memory>268435456</memory>
                    <log>
                      <prefix>QPID</prefix>
                      <color>${log.color.amqp-network}</color>
                    </log>
                    <wait>
                      <time>${service.startup.timeout}</time>
                      <log>.*(Listening on 0.0.0.0:5673)$</log>
                    </wait>
                    <env>
                      <PN_TRACE_FRM>0</PN_TRACE_FRM>
                    </env>
                  </run>
                </image>
                <!-- ##### Device Connection service ##### -->
                <image>
                  <name>${docker.repository}/hono-service-device-connection-test</name>
                  <alias>device-connection</alias>
                  <build>
                    <imagePullPolicy>IfNotPresent</imagePullPolicy>
                    <from>${docker.repository}/hono-service-device-connection:${project.version}</from>
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/</basedir>
                      <inline>
                        <id>config</id>
                        <fileSets>
                          <fileSet>
                            <directory>${project.build.directory}/resources/deviceconnection</directory>
                            <outputDirectory>etc/hono</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                          <fileSet>
                            <directory>${project.build.directory}/certs</directory>
                            <outputDirectory>etc/hono/certs</outputDirectory>
                            <includes>
                              <include>device-connection-*.pem</include>
                              <include>auth-server-cert.pem</include>
                              <include>trusted-certs.pem</include>
                            </includes>
                          </fileSet>
                        </fileSets>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <ports>
                      <port>+deviceconnection.ip:deviceconnection.amqp.port:5672</port>
                      <port>+deviceconnection.ip:deviceconnection.health.port:${vertx.health.port}</port>
                    </ports>
                    <portPropertyFile>${project.build.directory}/docker/deviceconnection.port.properties</portPropertyFile>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                      <alias>hono-service-device-connection.hono</alias>
                    </network>
                    <memorySwap>314572800</memorySwap>
                    <memory>314572800</memory>
                    <env>
                      <LOGGING_CONFIG>file:///etc/hono/logback-spring.xml</LOGGING_CONFIG>
                      <SPRING_CONFIG_LOCATION>file:///etc/hono/</SPRING_CONFIG_LOCATION>
                      <SPRING_PROFILES_ACTIVE>${logging.profile},embedded-cache</SPRING_PROFILES_ACTIVE>
                      <JDK_JAVA_OPTIONS>${default.java.options}</JDK_JAVA_OPTIONS>
                      <PN_TRACE_FRM>0</PN_TRACE_FRM>
                      <JAEGER_SERVICE_NAME>device-connection</JAEGER_SERVICE_NAME>
                      <JAEGER_AGENT_HOST>${jaeger.host}</JAEGER_AGENT_HOST>
                      <JAEGER_AGENT_PORT>6831</JAEGER_AGENT_PORT>
                      <JAEGER_SAMPLER_TYPE>const</JAEGER_SAMPLER_TYPE>
                      <JAEGER_SAMPLER_PARAM>1</JAEGER_SAMPLER_PARAM>
                    </env>
                    <log>
                      <prefix>DEVCON</prefix>
                      <color>${log.color.hono-services}</color>
                    </log>
                    <wait>
                      <time>${service.startup.timeout}</time>
                      <http>
                        <method>GET</method>
                        <url>http://${deviceconnection.ip}:${deviceconnection.health.port}/readiness</url>
                        <status>200..299</status>
                      </http>
                    </wait>
                  </run>
                </image>
                <!-- ##### HTTP adapter ##### -->
                <image>
                  <name>${docker.repository}/hono-adapter-http-test</name>
                  <alias>http-adapter</alias>
                  <build>
                    <imagePullPolicy>IfNotPresent</imagePullPolicy>
                    <from>${docker.repository}/hono-adapter-http-vertx:${project.version}</from>
                    <!--
                    Enable to test with Quarkus adapter
                    <from>${docker.image.org-name}/hono-adapter-http-vertx-quarkus:${project.version}</from>
                    -->
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/</basedir>
                      <inline>
                        <id>config</id>
                        <dependencySets>
                          <dependencySet>
                            <includes>
                              <!--  use openSSL in HTTP adapter -->
                              <include>io.netty:netty-tcnative-boringssl-static</include>
                            </includes>
                            <outputDirectory>opt/hono/extensions</outputDirectory>
                          </dependencySet>
                        </dependencySets>
                        <fileSets>
                          <fileSet>
                            <directory>${project.build.directory}/resources/http</directory>
                            <outputDirectory>etc/hono</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                          <!--
                          Enable to configure Quarkus JVM image
                          <fileSet>
                            <directory>${project.build.directory}/resources/http</directory>
                            <outputDirectory>/deployments/config</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                          -->
                          <fileSet>
                            <directory>${project.build.directory}/certs</directory>
                            <outputDirectory>etc/hono/certs</outputDirectory>
                            <includes>
                              <include>http-adapter-*.pem</include>
                              <include>trusted-certs.pem</include>
                            </includes>
                          </fileSet>
                        </fileSets>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <ports>
                      <port>+http.ip:http.port:8080</port>
                      <port>https.port:8443</port>
                      <port>+http.ip:http.health.port:${vertx.health.port}</port>
                    </ports>
                    <portPropertyFile>${project.build.directory}/docker/adapter.http.port.properties</portPropertyFile>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                      <alias>hono-adapter-http-vertx.hono</alias>
                    </network>
                    <memorySwap>314572800</memorySwap>
                    <memory>314572800</memory>
                    <env>
                      <LOGGING_CONFIG>file:/etc/hono/logback-spring.xml</LOGGING_CONFIG>
                      <SPRING_CONFIG_LOCATION>file:/etc/hono/</SPRING_CONFIG_LOCATION>
                      <SPRING_PROFILES_ACTIVE>${logging.profile}</SPRING_PROFILES_ACTIVE>
                      <JDK_JAVA_OPTIONS>${default.java.options} ${http.java.options}</JDK_JAVA_OPTIONS>
                      <PN_TRACE_FRM>0</PN_TRACE_FRM>
                      <JAEGER_SERVICE_NAME>hono-adapter-http</JAEGER_SERVICE_NAME>
                      <JAEGER_AGENT_HOST>${jaeger.host}</JAEGER_AGENT_HOST>
                      <JAEGER_AGENT_PORT>6831</JAEGER_AGENT_PORT>
                      <JAEGER_SAMPLER_TYPE>const</JAEGER_SAMPLER_TYPE>
                      <JAEGER_SAMPLER_PARAM>1</JAEGER_SAMPLER_PARAM>
                    </env>
                    <log>
                      <prefix>HTTP</prefix>
                      <color>${log.color.hono-protocol-adapters}</color>
                    </log>
                    <wait>
                      <time>${service.startup.timeout}</time>
                      <http>
                        <method>GET</method>
                        <url>http://${http.ip}:${http.health.port}/readiness</url>
                        <status>200..299</status>
                      </http>
                    </wait>
                  </run>
                </image>
                <!-- ##### MQTT adapter ##### -->
                <image>
                  <name>${docker.repository}/hono-adapter-mqtt-test</name>
                  <alias>mqtt-adapter</alias>
                  <build>
                    <imagePullPolicy>IfNotPresent</imagePullPolicy>
                    <from>${docker.repository}/hono-adapter-mqtt-vertx:${project.version}</from>
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/</basedir>
                      <inline>
                        <id>config</id>
                        <dependencySets>
                          <dependencySet>
                            <includes>
                              <!--  use native transport in MQTT adapter -->
                              <include>io.netty:netty-transport-native-*</include>
                            </includes>
                            <outputDirectory>opt/hono/extensions</outputDirectory>
                          </dependencySet>
                        </dependencySets>
                        <fileSets>
                          <fileSet>
                            <directory>${project.build.directory}/resources/mqtt</directory>
                            <outputDirectory>etc/hono</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                          <fileSet>
                            <directory>${project.build.directory}/certs</directory>
                            <outputDirectory>etc/hono/certs</outputDirectory>
                            <includes>
                              <include>mqtt-adapter-*.pem</include>
                              <include>trusted-certs.pem</include>
                            </includes>
                          </fileSet>
                        </fileSets>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <ports>
                      <port>+mqtt.ip:mqtt.port:1883</port>
                      <port>mqtts.port:8883</port>
                      <port>+mqtt.ip:mqtt.health.port:${vertx.health.port}</port>
                    </ports>
                    <portPropertyFile>${project.build.directory}/docker/adapter.mqtt.port.properties</portPropertyFile>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                      <alias>hono-adapter-mqtt-vertx.hono</alias>
                    </network>
                    <memorySwap>314572800</memorySwap>
                    <memory>314572800</memory>
                    <env>
                      <LOGGING_CONFIG>file:///etc/hono/logback-spring.xml</LOGGING_CONFIG>
                      <SPRING_CONFIG_LOCATION>file:///etc/hono/</SPRING_CONFIG_LOCATION>
                      <SPRING_PROFILES_ACTIVE>${logging.profile}</SPRING_PROFILES_ACTIVE>
                      <JDK_JAVA_OPTIONS>${default.java.options} ${mqtt.java.options}</JDK_JAVA_OPTIONS>
                      <PN_TRACE_FRM>0</PN_TRACE_FRM>
                      <JAEGER_SERVICE_NAME>hono-adapter-mqtt</JAEGER_SERVICE_NAME>
                      <JAEGER_AGENT_HOST>${jaeger.host}</JAEGER_AGENT_HOST>
                      <JAEGER_AGENT_PORT>6831</JAEGER_AGENT_PORT>
                      <JAEGER_SAMPLER_TYPE>const</JAEGER_SAMPLER_TYPE>
                      <JAEGER_SAMPLER_PARAM>1</JAEGER_SAMPLER_PARAM>
                    </env>
                    <log>
                      <prefix>MQTT</prefix>
                      <color>${log.color.hono-protocol-adapters}</color>
                    </log>
                    <wait>
                      <time>${service.startup.timeout}</time>
                      <http>
                        <method>GET</method>
                        <url>http://${mqtt.ip}:${mqtt.health.port}/readiness</url>
                        <status>200..299</status>
                      </http>
                    </wait>
                  </run>
                </image>
                <!-- ##### AMQP adapter ##### -->
                <image>
                  <name>${docker.repository}/hono-adapter-amqp-test</name>
                  <alias>amqp-adapter</alias>
                  <build>
                    <imagePullPolicy>IfNotPresent</imagePullPolicy>
                    <from>${docker.repository}/hono-adapter-amqp-vertx:${project.version}</from>
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/</basedir>
                      <inline>
                        <id>config</id>
                        <fileSets>
                          <fileSet>
                            <directory>${project.build.directory}/resources/amqp</directory>
                            <outputDirectory>etc/hono</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                          <fileSet>
                            <directory>${project.build.directory}/certs</directory>
                            <outputDirectory>etc/hono/certs</outputDirectory>
                            <includes>
                              <include>amqp-adapter-*.pem</include>
                              <include>trusted-certs.pem</include>
                            </includes>
                          </fileSet>
                        </fileSets>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <ports>
                      <port>+adapter.amqp.ip:adapter.amqp.port:5672</port>
                      <port>+adapter.amqps.ip:adapter.amqps.port:5671</port>
                      <port>+adapter.amqp.ip:adapter.amqp.health.port:${vertx.health.port}</port>
                    </ports>
                    <portPropertyFile>${project.build.directory}/docker/adapter.amqp.port.properties</portPropertyFile>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                      <alias>hono-adapter-amqp-vertx.hono</alias>
                    </network>
                    <memorySwap>314572800</memorySwap>
                    <memory>314572800</memory>
                    <env>
                      <LOGGING_CONFIG>file:///etc/hono/logback-spring.xml</LOGGING_CONFIG>
                      <SPRING_CONFIG_LOCATION>file:///etc/hono/</SPRING_CONFIG_LOCATION>
                      <SPRING_PROFILES_ACTIVE>${logging.profile}</SPRING_PROFILES_ACTIVE>
                      <JDK_JAVA_OPTIONS>${default.java.options} ${amqp.java.options}</JDK_JAVA_OPTIONS>
                      <PN_TRACE_FRM>0</PN_TRACE_FRM>
                      <JAEGER_SERVICE_NAME>hono-adapter-amqp</JAEGER_SERVICE_NAME>
                      <JAEGER_AGENT_HOST>${jaeger.host}</JAEGER_AGENT_HOST>
                      <JAEGER_AGENT_PORT>6831</JAEGER_AGENT_PORT>
                      <JAEGER_SAMPLER_TYPE>const</JAEGER_SAMPLER_TYPE>
                      <JAEGER_SAMPLER_PARAM>1</JAEGER_SAMPLER_PARAM>
                    </env>
                    <log>
                      <prefix>AMQP</prefix>
                      <color>${log.color.hono-protocol-adapters}</color>
                    </log>
                    <wait>
                      <time>${service.startup.timeout}</time>
                      <http>
                        <method>GET</method>
                        <url>http://${adapter.amqp.ip}:${adapter.amqp.health.port}/readiness</url>
                        <status>200..299</status>
                      </http>
                    </wait>
                  </run>
                </image>
                <!-- ##### CoAP adapter ##### -->
                <image>
                  <name>${docker.repository}/hono-adapter-coap-test</name>
                  <alias>coap-adapter</alias>
                  <build>
                    <imagePullPolicy>IfNotPresent</imagePullPolicy>
                    <from>${docker.repository}/hono-adapter-coap-vertx:${project.version}</from>
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/</basedir>
                      <inline>
                        <id>config</id>
                        <fileSets>
                          <fileSet>
                            <directory>${project.build.directory}/resources/coap</directory>
                            <outputDirectory>etc/hono</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                          <fileSet>
                            <directory>${project.build.directory}/certs</directory>
                            <outputDirectory>etc/hono/certs</outputDirectory>
                            <includes>
                              <include>coap-adapter-*.pem</include>
                              <include>trusted-certs.pem</include>
                            </includes>
                          </fileSet>
                        </fileSets>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <ports>
                      <port>+coap.ip:coap.port:5683/udp</port>
                      <port>coaps.port:5684/udp</port>
                      <port>+coap.ip:coap.health.port:${vertx.health.port}</port>
                    </ports>
                    <portPropertyFile>${project.build.directory}/docker/adapter.coap.port.properties</portPropertyFile>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                      <alias>hono-adapter-coap-vertx.hono</alias>
                    </network>
                    <memorySwap>268435456</memorySwap>
                    <memory>268435456</memory>
                    <env>
                      <LOGGING_CONFIG>file:/etc/hono/logback-spring.xml</LOGGING_CONFIG>
                      <SPRING_CONFIG_LOCATION>file:/etc/hono/</SPRING_CONFIG_LOCATION>
                      <SPRING_PROFILES_ACTIVE>${logging.profile}</SPRING_PROFILES_ACTIVE>
                      <JDK_JAVA_OPTIONS>${default.java.options} ${coap.java.options}</JDK_JAVA_OPTIONS>
                      <PN_TRACE_FRM>0</PN_TRACE_FRM>
                      <JAEGER_SERVICE_NAME>hono-adapter-coap</JAEGER_SERVICE_NAME>
                      <JAEGER_AGENT_HOST>${jaeger.host}</JAEGER_AGENT_HOST>
                      <JAEGER_AGENT_PORT>6831</JAEGER_AGENT_PORT>
                      <JAEGER_SAMPLER_TYPE>const</JAEGER_SAMPLER_TYPE>
                      <JAEGER_SAMPLER_PARAM>1</JAEGER_SAMPLER_PARAM>
                    </env>
                    <log>
                      <prefix>COAP</prefix>
                      <color>${log.color.hono-protocol-adapters}</color>
                    </log>
                    <wait>
                      <time>${service.startup.timeout}</time>
                      <http>
                        <method>GET</method>
                        <url>http://${coap.ip}:${coap.health.port}/readiness</url>
                        <status>200..299</status>
                      </http>
                    </wait>
                  </run>
                </image>
              </images>
            </configuration>
            <executions>
              <execution>
                <id>build_images</id>
                <phase>package</phase>
                <goals>
                  <goal>build</goal>
                </goals>
              </execution>
              <execution>
                <id>start-docker</id>
                <phase>pre-integration-test</phase>
                <goals>
                  <goal>start</goal>
                </goals>
              </execution>
              <execution>
                <id>stop-and-remove-docker</id>
                <phase>post-integration-test</phase>
                <goals>
                  <goal>stop</goal>
                  <goal>remove</goal>
                </goals>
                <configuration>
                  <removeVolumes>true</removeVolumes>
                  <removeMode>all</removeMode>
                </configuration>
              </execution>
            </executions>
          </plugin>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <configuration>
              <skip>true</skip>
            </configuration>
          </plugin>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-failsafe-plugin</artifactId>
            <configuration>
              <environmentVariables>
                <PN_TRACE_FRM>${trace.frames}</PN_TRACE_FRM>
              </environmentVariables>
              <systemProperties>
                <auth.host>${auth.ip}</auth.host>
                <auth.amqp.port>${auth.amqp.port}</auth.amqp.port>
                <hono.username>hono-client</hono.username>
                <hono.password>secret</hono.password>
                <tenant.admin.username>http-adapter@HONO</tenant.admin.username>
                <tenant.admin.password>http-secret</tenant.admin.password>
                <downstream.host>${qpid.ip}</downstream.host>
                <downstream.amqp.port>${qpid.amqp.port}</downstream.amqp.port>
                <downstream.username>consumer@HONO</downstream.username>
                <downstream.password>verysecret</downstream.password>
                <deviceconnection.host>${deviceconnection.ip}</deviceconnection.host>
                <deviceconnection.amqp.port>${deviceconnection.amqp.port}</deviceconnection.amqp.port>
                <deviceregistry.host>${deviceregistry.ip}</deviceregistry.host>
                <deviceregistry.amqp.port>${deviceregistry.amqp.port}</deviceregistry.amqp.port>
                <deviceregistry.http.port>${deviceregistry.http.port}</deviceregistry.http.port>
                <deviceregistry.supportsGatewayMode>${deviceregistry.supportsGatewayMode}</deviceregistry.supportsGatewayMode>
                <deviceregistry.credentials.supportsClientContext>${deviceregistry.credentials.supportsClientContext}</deviceregistry.credentials.supportsClientContext>
                <deviceregistry.supportsSearchDevices>${deviceregistry.supportsSearchDevices}</deviceregistry.supportsSearchDevices>
                <adapter.coap.host>${coap.ip}</adapter.coap.host>
                <adapter.coap.port>${coap.port}</adapter.coap.port>
                <adapter.coaps.port>${coaps.port}</adapter.coaps.port>
                <adapter.http.host>${http.ip}</adapter.http.host>
                <adapter.http.port>${http.port}</adapter.http.port>
                <adapter.https.port>${https.port}</adapter.https.port>
                <adapter.mqtt.host>${mqtt.ip}</adapter.mqtt.host>
                <adapter.mqtt.port>${mqtt.port}</adapter.mqtt.port>
                <adapter.mqtts.port>${mqtts.port}</adapter.mqtts.port>
                <adapter.amqp.host>${adapter.amqp.ip}</adapter.amqp.host>
                <adapter.amqp.port>${adapter.amqp.port}</adapter.amqp.port>
                <adapter.amqps.port>${adapter.amqps.port}</adapter.amqps.port>
                <adapter.sendMessageToDeviceTimeout>${adapter.sendMessageToDeviceTimeout}</adapter.sendMessageToDeviceTimeout>
                <trust-store.path>${project.build.directory}/certs/trusted-certs.pem</trust-store.path>
                <test.env>${test.env}</test.env>
                <max.bcrypt.costFactor>${max.bcrypt.costFactor}</max.bcrypt.costFactor>
                <vertx.logger-delegate-factory-class-name>io.vertx.core.logging.SLF4JLogDelegateFactory</vertx.logger-delegate-factory-class-name>
                <!-- javax.net.debug>ssl:handshake</javax.net.debug-->
              </systemProperties>
              <failIfNoSpecifiedTests>false</failIfNoSpecifiedTests>
            </configuration>
            <executions>
              <execution>
                <goals>
                  <goal>integration-test</goal>
                  <goal>verify</goal>
                </goals>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>
    <profile>
      <id>useRunningContainers</id>
      <build>
        <plugins>
          <plugin>
            <groupId>org.codehaus.mojo</groupId>
            <artifactId>properties-maven-plugin</artifactId>
            <executions>
              <execution>
                <phase>initialize</phase>
                <goals>
                  <goal>read-project-properties</goal>
                </goals>
                <configuration>
                  <files>
                    <file>${project.build.directory}/docker/jaeger.port.properties</file>
                    <file>${project.build.directory}/docker/auth.port.properties</file>
                    <file>${project.build.directory}/docker/deviceregistry.port.properties</file>
                    <file>${project.build.directory}/docker/broker.port.properties</file>
                    <file>${project.build.directory}/docker/qpid.port.properties</file>
                    <file>${project.build.directory}/docker/adapter.http.port.properties</file>
                    <file>${project.build.directory}/docker/adapter.mqtt.port.properties</file>
                    <file>${project.build.directory}/docker/adapter.amqp.port.properties</file>
                    <file>${project.build.directory}/docker/adapter.coap.port.properties</file>
                  </files>
                </configuration>
              </execution>
            </executions>
          </plugin>
          <plugin>
            <groupId>io.fabric8</groupId>
            <artifactId>docker-maven-plugin</artifactId>
            <executions>
              <!-- disable 'build', 'start' and 'stop-and-remove' executions -->
              <execution>
                <id>build_images</id>
                <phase>none</phase>
              </execution>
              <execution>
                <id>start-docker</id>
                <phase>none</phase>
              </execution>
              <execution>
                <id>stop-and-remove-docker</id>
                <phase>none</phase>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>
    <profile>
      <id>stopContainers</id>
      <build>
        <plugins>
          <plugin>
            <groupId>io.fabric8</groupId>
            <artifactId>docker-maven-plugin</artifactId>
            <configuration>
              <verbose>true</verbose>
            </configuration>
            <executions>
              <!-- disable 'build' and 'start' executions -->
              <execution>
                <id>build_images</id>
                <phase>none</phase>
              </execution>
              <execution>
                <id>start-docker</id>
                <phase>none</phase>
              </execution>
              <execution>
                <id>stop-and-remove-docker</id>
                <phase>post-integration-test</phase>
                <goals>
                  <goal>stop</goal>
                  <goal>remove</goal>
                </goals>
                <configuration>
                  <removeVolumes>true</removeVolumes>
                  <removeMode>all</removeMode>
                  <stopNamePattern>hono-*-test*</stopNamePattern>
                </configuration>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>
    <profile>
      <id>jaeger</id>
      <properties>
        <jaeger.disabled>false</jaeger.disabled>
      </properties>
    </profile>
  </profiles>
</project>
