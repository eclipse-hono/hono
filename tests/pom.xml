<?xml version="1.0" encoding="UTF-8"?>
<!-- Copyright (c) 2016 Bosch Software Innovations GmbH. All rights reserved. This program and the accompanying 
  materials are made available under the terms of the Eclipse Public License v1.0 which accompanies this distribution, 
  and is available at http://www.eclipse.org/legal/epl-v10.html Contributors: Bosch Software Innovations GmbH - initial 
  creation -->
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <parent>
    <groupId>org.eclipse.hono</groupId>
    <artifactId>hono-bom</artifactId>
    <version>0.5-M6-SNAPSHOT</version>
    <relativePath>../bom</relativePath>
  </parent>
  <modelVersion>4.0.0</modelVersion>

  <artifactId>hono-tests</artifactId>

  <name>Hono Integration Tests</name>
  <description>Integration tests verifying Hono's APIs.
Test cases are run against Docker images of Hono server + (Apache Qpid Dispatch Router | ActiveMQ broker).</description>

  <properties>
    <image.target>hono-test-config</image.target>
    <maven.javadoc.skip>true</maven.javadoc.skip>
    <maven.source.skip>true</maven.source.skip>
    <maven.install.skip>true</maven.install.skip>
    <gpg.skip>true</gpg.skip>
  </properties>

  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
    </dependency>
    <dependency>
      <groupId>org.eclipse.hono</groupId>
      <artifactId>hono-client</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.eclipse.hono</groupId>
      <artifactId>hono-core</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.vertx</groupId>
      <artifactId>vertx-core</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.vertx</groupId>
      <artifactId>vertx-proton</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>ch.qos.logback</groupId>
      <artifactId>logback-classic</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>io.vertx</groupId>
      <artifactId>vertx-unit</artifactId>
    </dependency>
    <dependency>
      <groupId>org.apache.qpid</groupId>
      <artifactId>qpid-jms-client</artifactId>
    </dependency>
  </dependencies>

  <profiles>
    <profile>
      <id>run-tests</id>
      <build>
        <plugins>
          <plugin>
            <groupId>io.fabric8</groupId>
            <artifactId>docker-maven-plugin</artifactId>
            <configuration>
              <verbose>true</verbose>
              <autoCreateCustomNetworks>true</autoCreateCustomNetworks>
              <startParallel>true</startParallel>
              <images>
                <!-- ##### Hono server ##### -->
                <image>
                  <name>eclipsehono/hono-test-server</name>
                  <alias>server</alias>
                  <build>
                    <from>eclipsehono/hono-server:${project.version}</from>
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/etc/hono</basedir>
                      <inline>
                        <id>config</id>
                        <fileSets>
                          <fileSet>
                            <directory>${project.basedir}/src/test/resources/server</directory>
                            <outputDirectory>.</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                        </fileSets>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <ports>
                      <port>+hono.ip:hono.amqp.port:5672</port>
                    </ports>
                    <network>
                      <mode>custom</mode>
                      <name>hono</name>
                    </network>
                    <env>
                      <LOGGING_CONFIG>file:///etc/hono/logback-spring.xml</LOGGING_CONFIG>
                      <SPRING_CONFIG_LOCATION>file:///etc/hono/</SPRING_CONFIG_LOCATION>
                      <!--<PN_TRACE_FRM>1</PN_TRACE_FRM>-->
                      <SPRING_PROFILES_ACTIVE>registration-file,credentials-file,qpid,prod</SPRING_PROFILES_ACTIVE>
                    </env>
                    <log>
                      <prefix>HONO</prefix>
                      <color>green</color>
                    </log>
                    <wait>
                      <log>^.*(startup completed successfully)$</log>
                    </wait>
                  </run>
                </image>
                <!-- ##### Qpid Dispatch Router ##### -->
                <image>
                  <name>eclipsehono/dispatch-router:${project.version}</name>
                  <alias>qdrouter</alias>
                  <run>
                    <cmd>
                      <shell>/usr/sbin/qdrouterd -c /etc/hono/qdrouter/qdrouterd-with-broker.json</shell>
                    </cmd>
                    <ports>
                      <port>+qpid.ip:qpid.amqp.port:5672</port>
                      <port>qpid.amqp.internal.port:5673</port>
                    </ports>
                    <network>
                      <name>hono</name>
                      <alias>qdrouter</alias>
                    </network>
                    <log>
                      <prefix>QPID</prefix>
                      <color>blue</color>
                    </log>
                    <!--
                    <env>
                       <PN_TRACE_FRM>1</PN_TRACE_FRM>
                    </env>
                    -->
                  </run>
                </image>
                <!-- ##### ActiveMQ Artemis message broker ##### -->
                <image>
                  <name>eclipsehono/broker:${project.version}</name>
                  <alias>broker</alias>
                  <run>
                    <ports>
                      <port>+broker.ip:broker.amqp.port:5672</port>
                    </ports>
                    <network>
                      <name>hono</name>
                      <alias>broker</alias>
                    </network>
                    <log>
                      <prefix>Artemis</prefix>
                      <color>magenta</color>
                    </log>
                    <!--
                    <env>
                       <PN_TRACE_FRM>1</PN_TRACE_FRM>
                    </env>
                    -->
                    <wait>
                      <log>^.*Server is now live.*$</log>
                    </wait>
                  </run>
                </image>
              </images>
            </configuration>
            <executions>
              <execution>
                <phase>package</phase>
                <goals>
                  <goal>build</goal>
                </goals>
              </execution>
              <execution>
                <id>start-docker</id>
                <phase>pre-integration-test</phase>
                <goals>
                  <goal>start</goal>
                </goals>
              </execution>
              <execution>
                <id>stop-docker</id>
                <phase>post-integration-test</phase>
                <goals>
                  <goal>stop</goal>
                  <goal>remove</goal>
                </goals>
              </execution>
            </executions>
          </plugin>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <configuration>
              <skip>true</skip>
            </configuration>
          </plugin>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-failsafe-plugin</artifactId>
            <configuration>
              <systemProperties>
                <hono.host>${hono.ip}</hono.host>
                <hono.amqp.port>${hono.amqp.port}</hono.amqp.port>
                <downstream.host>${qpid.ip}</downstream.host>
                <downstream.amqp.port>${qpid.amqp.port}</downstream.amqp.port>
              </systemProperties>
              <failIfNoSpecifiedTests>false</failIfNoSpecifiedTests>
              <test>*IT</test>
            </configuration>
            <executions>
              <execution>
                <id>run-integration-tests</id>
                <phase>integration-test</phase>
                <goals>
                  <goal>integration-test</goal>
                </goals>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>

    <profile>
      <id>run-activemq-tests</id>
      <build>
        <plugins>
          <plugin>
            <groupId>io.fabric8</groupId>
            <artifactId>docker-maven-plugin</artifactId>
            <configuration>
              <verbose>true</verbose>
              <autoCreateCustomNetworks>true</autoCreateCustomNetworks>
              <startParallel>true</startParallel>
              <images>
                <!-- ##### Hono server ##### -->
                <image>
                  <name>eclipsehono/hono-test-server</name>
                  <alias>server</alias>
                  <build>
                    <from>eclipsehono/hono-server:${project.version}</from>
                    <assembly>
                      <mode>dir</mode>
                      <basedir>/etc/hono</basedir>
                      <inline>
                        <id>config</id>
                        <fileSets>
                          <fileSet>
                            <directory>${project.basedir}/src/test/resources/server</directory>
                            <outputDirectory>.</outputDirectory>
                            <includes>
                              <include>*</include>
                            </includes>
                          </fileSet>
                        </fileSets>
                      </inline>
                    </assembly>
                  </build>
                  <run>
                    <ports>
                      <port>+hono.ip:hono.amqp.port:5672</port>
                    </ports>
                    <network>
                      <name>hono</name>
                    </network>
                    <env>
                      <LOGGING_CONFIG>file:///etc/hono/logback-spring.xml</LOGGING_CONFIG>
                      <SPRING_CONFIG_LOCATION>file:/etc/hono/</SPRING_CONFIG_LOCATION>
                      <SPRING_PROFILES_ACTIVE>registration-file,credentials-file,activemq,prod</SPRING_PROFILES_ACTIVE>
                    </env>
                    <log>
                      <prefix>HONO</prefix>
                      <color>green</color>
                    </log>
                    <wait>
                      <log>^.*(startup completed successfully)$</log>
                    </wait>
                  </run>
                </image>
                <!-- ##### ActiveMQ Broker ##### -->
                <image>
                  <name>rmohr/activemq:${activemq.version}</name>
                  <alias>activemq</alias>
                  <run>
                    <ports>
                      <port>+broker.ip:broker.amqp.port:5672</port>
                    </ports>
                    <network>
                      <name>hono</name>
                      <alias>activemq</alias>
                    </network>
                    <log>
                      <prefix>ACTIVEMQ</prefix>
                      <color>blue</color>
                    </log>
                    <wait>
                      <log>^.*Connector amqp started.*$</log>
                    </wait>
                  </run>
                </image>
              </images>
            </configuration>
            <executions>
              <execution>
                <phase>package</phase>
                <goals>
                  <goal>build</goal>
                </goals>
              </execution>
              <execution>
                <id>start-docker</id>
                <phase>pre-integration-test</phase>
                <goals>
                  <goal>start</goal>
                </goals>
              </execution>
              <execution>
                <id>stop-docker</id>
                <phase>post-integration-test</phase>
                <goals>
                  <goal>stop</goal>
                  <goal>remove</goal>
                </goals>
              </execution>
            </executions>
          </plugin>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <configuration>
              <skip>true</skip>
            </configuration>
          </plugin>
          <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-failsafe-plugin</artifactId>
            <configuration>
              <systemProperties>
                <hono.host>${hono.ip}</hono.host>
                <hono.amqp.port>${hono.amqp.port}</hono.amqp.port>
                <hono.pathSeparator>.</hono.pathSeparator>
                <downstream.host>${broker.ip}</downstream.host>
                <downstream.amqp.port>${broker.amqp.port}</downstream.amqp.port>
              </systemProperties>
              <test>*IT, !*ClientIT#*FailsForTenantWithoutAuthorization</test>
            </configuration>
            <executions>
              <execution>
                <id>run-integration-tests</id>
                <phase>integration-test</phase>
                <goals>
                  <goal>integration-test</goal>
                </goals>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>
  </profiles>
</project>